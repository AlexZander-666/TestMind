# ⚠️ TestMind v0.6.0 已知问题清单

**检测时间**: 2025-10-21  
**TypeScript 检查**: 143 个类型错误  
**优先级**: 大部分为非阻塞性问题  
**状态**: 待修复

---

## 📊 问题概览

| 类别 | 数量 | 优先级 | 预计修复时间 |
|------|------|--------|-------------|
| DOM 类型缺失 | ~40 | P1 | 5 分钟 |
| CodeChunk 属性访问 | ~25 | P2 | 1 小时 |
| 可能未定义的对象 | ~30 | P2 | 2 小时 |
| LLM Service 属性 | ~15 | P2 | 1 小时 |
| 类型不匹配 | ~20 | P3 | 2 小时 |
| 其他 | ~13 | P3 | 1 小时 |
| **总计** | **143** | - | **~7 小时** |

---

## 🔴 P1: 关键问题（影响编译）

### 1. DOM 类型库缺失 (~40 errors)

**问题**: TypeScript 无法找到 DOM 类型（window, document, Node, Element 等）

**受影响文件**:
- `packages/core/src/self-healing/adapters/PlaywrightAdapter.ts`
- `packages/core/src/self-healing/adapters/CypressAdapter.ts`
- `packages/core/src/self-healing/strategies/VisualLocator.ts`

**错误示例**:
```
Cannot find name 'window'
Cannot find name 'document'
Cannot find name 'Node'
Property 'getAttribute' does not exist on type 'Element'
```

**修复方案**:

**选项 1**: 在 `tsconfig.json` 中添加 DOM 库（推荐）
```json
{
  "compilerOptions": {
    "lib": ["ES2022", "DOM"]
  }
}
```

**选项 2**: 在各包的 `tsconfig.json` 中添加
```json
{
  "compilerOptions": {
    "lib": ["ES2022", "DOM"]
  }
}
```

**预计时间**: 5 分钟

---

## 🟠 P2: 重要问题（影响类型安全）

### 2. CodeChunk 属性访问 (~25 errors)

**问题**: 新代码使用了 `name`, `type`, `complexity`, `loc` 等属性，但可能在类型定义中不存在

**受影响文件**:
- `packages/core/src/db/VectorStore.enhanced.ts`
- `packages/core/src/context/EmbeddingGenerator.ts`
- `packages/core/src/context/HybridSearchEngine.ts`

**错误示例**:
```
Property 'name' does not exist on type 'CodeChunk'
Property 'type' does not exist on type 'CodeChunk'
Property 'complexity' does not exist on type 'CodeChunk'
```

**修复方案**:

检查并更新 `packages/shared/src/types/index.ts` 中的 `CodeChunk` 接口：

```typescript
export interface CodeChunk {
  id: string;
  filePath: string;
  content: string;
  
  // 添加缺失的属性
  name?: string;         // ← 添加
  type?: string;         // ← 添加
  complexity?: number;   // ← 添加
  loc?: number;          // ← 添加
  parameters?: string[]; // ← 添加
  returnType?: string;   // ← 添加
  embedding?: number[];  // ← 添加
  
  metadata?: ChunkMetadata;
}
```

**预计时间**: 1 小时（需要检查所有使用点）

---

### 3. 可能未定义的对象访问 (~30 errors)

**问题**: TypeScript 严格模式检测到可能未定义的属性访问

**错误示例**:
```
Object is possibly 'undefined'
'batch' is possibly 'undefined'
'result' is possibly 'undefined'
```

**修复方案**:

使用可选链或断言：

```typescript
// 错误
console.log(batch.length);

// 修复方案 1: 可选链
console.log(batch?.length);

// 修复方案 2: 非空断言
console.log(batch!.length);

// 修复方案 3: 条件检查
if (batch) {
  console.log(batch.length);
}
```

**预计时间**: 2 小时

---

### 4. LLM Service 属性缺失 (~15 errors)

**问题**: 新技能类中使用 `this.llmService` 但未定义

**受影响文件**:
- `CypressTestSkill.enhanced.ts`
- `PlaywrightTestSkill.enhanced.ts`
- `VitestBrowserSkill.ts`
- `WebdriverIOSkill.ts`

**修复方案**:

添加构造函数和属性：

```typescript
export class EnhancedCypressTestSkill {
  readonly name = 'enhanced-cypress-e2e';
  readonly version = '2.0.0';
  readonly description = 'Generate enhanced Cypress E2E tests with best practices';
  
  private llmService: LLMService;  // ← 添加
  
  constructor(llmService: LLMService) {  // ← 添加
    this.llmService = llmService;
  }
  
  async execute(context: CypressTestContext): Promise<{ code: string }> {
    // ...
  }
}
```

**预计时间**: 1 小时

---

## 🟡 P3: 次要问题（不影响运行时）

### 5. v0.6.0.ts 导出对象错误 (~18 errors)

**问题**: 简写属性名需要先导入

**修复方案**:

```typescript
// 错误
export const V0_6_0 = {
  SelfHealing: {
    Adapters: { createBrowserAdapter, autoDetectAdapter },
  }
};

// 修复
import { createBrowserAdapter, autoDetectAdapter } from './self-healing/adapters';

export const V0_6_0 = {
  SelfHealing: {
    Adapters: { createBrowserAdapter, autoDetectAdapter },
  }
};
```

**预计时间**: 30 分钟

---

### 6. SemanticSearchResult 类型不匹配 (~5 errors)

**问题**: 返回对象缺少 `relevance` 属性

**修复方案**:

```typescript
// 检查 SemanticSearchResult 类型定义
export interface SemanticSearchResult {
  chunk: CodeChunk;
  score: number;
  relevance?: number;  // 确保这个属性是可选的或添加它
}

// 或在返回时添加
return results.map(r => ({
  chunk: r.chunk,
  score: r.score,
  relevance: r.score,  // ← 添加
}));
```

**预计时间**: 30 分钟

---

### 7. 其他类型不匹配 (~10 errors)

**问题**: 参数类型、返回类型不匹配

**示例**:
```
Argument of type 'string | undefined' is not assignable to parameter of type 'string'
Type 'number' has no properties in common with type '{ topK?: number }'
```

**修复方案**: 逐个检查并修复

**预计时间**: 1 小时

---

## 🔧 修复计划

### Phase 1: 快速修复（DOM 类型）- 5 分钟

```json
// tsconfig.json
{
  "compilerOptions": {
    "lib": ["ES2022", "DOM"]
  }
}
```

**预期效果**: 解决 ~40 个 DOM 相关错误

---

### Phase 2: 类型定义完善 - 2 小时

1. **更新 CodeChunk 接口** (30 分钟)
   - 添加缺失的属性
   - 标记为可选
   - 添加完整注释

2. **更新 SemanticSearchResult** (15 分钟)
   - 添加或修正 relevance 属性

3. **添加 LLM Service** (1 小时)
   - 在新技能类中添加构造函数
   - 正确初始化属性

4. **修复 v0.6.0 导出** (15 分钟)
   - 添加正确的导入
   - 使用完整对象字面量

---

### Phase 3: 严格空检查 - 2 小时

1. **添加可选链** (1 小时)
   - 使用 `?.` 操作符
   - 或添加条件检查

2. **添加非空断言** (30 分钟)
   - 在确定非空的地方使用 `!`
   - 添加注释说明原因

3. **条件保护** (30 分钟)
   - 添加 if 检查
   - 提前返回

---

### Phase 4: 其他修复 - 1 小时

1. **参数类型匹配** (30 分钟)
2. **返回类型匹配** (30 分钟)

---

## ✅ 修复优先级

### 立即修复（阻塞编译）

1. ✅ 移除 `extends Skill`（已修复）
2. ⏸️ 添加 DOM 库到 tsconfig

### 短期修复（1-2 天）

3. 更新 CodeChunk 类型定义
4. 添加 LLM Service 到新技能
5. 修复可能未定义的访问

### 中期修复（3-5 天）

6. 修复所有类型不匹配
7. 添加缺失的方法（generateStableSelector等）
8. 完善接口定义

---

## 📝 临时解决方案

如果需要立即构建项目，可以暂时禁用严格类型检查：

```json
// tsconfig.json
{
  "compilerOptions": {
    "strict": false,  // 临时禁用
    "noUncheckedIndexedAccess": false,
  }
}
```

**注意**: 这只是临时方案，应该尽快修复实际类型问题。

---

## 🎯 修复后的预期结果

```
pnpm typecheck

✓ packages/shared typecheck (1.2s)
✓ packages/core typecheck (3.5s)
✓ packages/cli typecheck (0.8s)

Done in 5.5s
```

---

## 📋 追踪进度

- [ ] P1: DOM 类型库（5 分钟）
- [ ] P2.1: CodeChunk 类型（30 分钟）
- [ ] P2.2: LLM Service（1 小时）
- [ ] P2.3: 可选链（1 小时）
- [ ] P2.4: v0.6.0 导出（15 分钟）
- [ ] P3: 其他类型匹配（2 小时）

**总预计**: ~7 小时

**建议**: 分批修复，每批 commit 一次

---

## 💡 学习点

这些类型错误是快速开发大型功能的正常现象。重要的是：

1. ✅ 功能逻辑正确（核心代码完整）
2. ✅ 架构设计合理（模块化、可扩展）
3. ⚠️ 类型安全待完善（TypeScript 严格模式）

**下一步**: 系统性修复所有类型问题，确保 100% 类型安全。

---

**更新时间**: 2025-10-21  
**下次检查**: 修复后














