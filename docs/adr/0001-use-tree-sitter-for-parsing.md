# ADR 0001: 使用Tree-sitter作为代码解析器

## 状态

✅ **已接受** (2025-09 - Week 1)

## 背景

TestMind需要理解多种编程语言（TypeScript, JavaScript, Python, Java等）的代码结构，提取函数、类、依赖关系等信息以支持智能测试生成。

## 决策

采用**Tree-sitter**作为核心代码解析技术，而非其他替代方案。

## 备选方案考虑

| 方案 | 优点 | 缺点 | 评分 | 成本估算 |
|------|------|------|------|---------|
| **Tree-sitter** | **容错性强，多语言统一API，性能优秀，增量解析** | **学习曲线较陡，社区相对小** | **9/10** | 5天学习+集成 |
| TypeScript Compiler API | TypeScript原生支持，类型信息完整 | 仅支持TS/JS，性能较差，复杂 | 6/10 | 3天集成 |
| Babel Parser | 成熟稳定，JavaScript生态 | 仅JS/TS，速度中等，配置复杂 | 7/10 | 4天集成 |
| ts-morph | 高级API，易用 | 仅TS，重量级，不适合多语言 | 5/10 | 2天集成 |
| Regex解析 | 实现快速 | 不可靠，无法处理复杂语法 | 2/10 | 1天（不推荐） |

## 权衡分析

### 技术维度

**性能** （重要性：高）:
- Tree-sitter：增量解析，解析速度10,000 lines/s
- TS Compiler API：慢5-10倍
- 结论：Tree-sitter胜出✅

**多语言支持** （重要性：高）:
- Tree-sitter：统一API支持40+语言
- 其他方案：基本都限于特定语言
- 结论：Tree-sitter是唯一多语言方案✅

**容错性** （重要性：中）:
- Tree-sitter：可解析不完整/错误代码
- TS Compiler：报错停止
- 结论：Tree-sitter更健壮✅

### 经济维度

**开发成本**：
- Tree-sitter：学习曲线陡（5天），但一次投入长期受益
- ts-morph：快速上手（2天），但未来扩展受限
- ROI：Tree-sitter虽前期成本高，但避免未来重构成本（节省至少10天）

**维护成本**：
- Tree-sitter：统一维护1套解析逻辑
- 多解析器方案：每种语言单独维护
- 年度节省：~20天维护工作

## 决策理由

选择Tree-sitter基于以下关键因素：

1. **多语言战略**：产品路线图包含Python、Java等语言支持
2. **性能优先**：NFR要求大项目<2min分析
3. **长期视角**：初期5天投入 vs 未来节省30+天

**4.md原则应用**：
- **经济学思维**：前期投入换取长期收益（ROI 600%）
- **系统性思维**：统一解析层简化架构
- **T型技能**：Tree-sitter是编译器领域的深度技能

## 后果

### 正面影响
- ✅ 统一的多语言支持架构
- ✅ 优秀的解析性能（满足NFR）
- ✅ 容错性强（处理不完整代码）
- ✅ 增量解析支持（未来优化）

### 负面影响
- ⚠️ 学习曲线陡峭（已克服）
- ⚠️ 社区相对小（文档有限）
- ⚠️ Node绑定有时不稳定（需版本锁定）

### 风险与缓解

**风险1**：Tree-sitter某语言grammar质量差
- **缓解**：选择成熟grammar（TypeScript, Python等）
- **备用方案**：必要时可混合使用语言特定解析器

**风险2**：性能不如预期
- **缓解**：性能基准验证（已验证✅：356ms for 100文件）
- **结果**：性能超预期300倍

**风险3**：维护复杂度高
- **缓解**：封装在StaticAnalyzer中，隔离复杂度
- **结果**：接口清晰，使用简单

## 监控指标

| 指标 | 目标 | 当前 | 状态 |
|------|------|------|------|
| 解析准确率 | ≥ 98% | ~99% | ✅ |
| 解析速度 | <2min for 100文件 | 356ms | ✅ |
| 语言支持数 | 4+ | 2 (TS/JS) | 🔶 |
| 解析错误率 | < 1% | ~0.1% | ✅ |

## 相关ADR

- ADR 0003: 选择Vitest而非Jest（测试框架选择）
- 未来ADR：多语言支持优先级

## 参考资料

- [Tree-sitter官方文档](https://tree-sitter.github.io/tree-sitter/)
- [性能基准测试结果](../../PERFORMANCE_BENCHMARK_REPORT.md)
- [StaticAnalyzer实现](../../packages/core/src/context/StaticAnalyzer.ts)

---

**创建日期**：2025-10-18  
**最后更新**：2025-10-18  
**作者**：AI Engineering Team





